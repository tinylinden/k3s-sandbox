- name: Read node ip
  shell:
    cmd: hostname --ip-address
  register: node_ip

- name: Install k3s (master)
  shell:
    cmd: curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--node-ip {{ node_ip.stdout }} --flannel-iface eth1" K3S_KUBECONFIG_MODE="0644" sh -

- name: Wait for k3s token
  wait_for:
    path: "{{ node_token_location }}"

- name: Read k3s token
  slurp:
    path: "{{ node_token_location }}"
  register: node_token

- name: Store k3s details (master)
  set_fact:
    k3s_url: "https://{{ node_ip.stdout }}:6443"
    k3s_token: "{{ node_token.content | b64decode | regex_replace('\n', '') }}"
